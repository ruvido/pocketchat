<!DOCTYPE html>
<html lang="en">
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    :root { --max-width: 600px; }
    * { box-sizing: border-box; }
    body { 
      margin: 0; 
      font-family: system-ui;
      height: 100vh;
      display: flex;
      flex-direction: column;
    }
    /* Authentication container */
    #auth-container {
      max-width: var(--max-width);
      margin: auto;
      padding: 2rem;
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }
    #auth-container input, 
    #auth-container button {
      padding: 0.8rem;
      border: 1px solid #ddd;
      border-radius: 0.5rem;
      font-size: 1rem;
    }
    #auth-container button {
      background: #007bff;
      color: white;
      border: none;
      cursor: pointer;
    }
    /* Chat styles */
    #chat-container {
      flex: 1;
      display: flex;
      flex-direction: column;
      max-width: var(--max-width);
      margin: auto;
      width: 100%;
    }
    #messages {
      flex: 1;
      overflow-y: auto;
      padding: 1rem;
      padding-bottom: 70px;
    }
    .message {
      margin-bottom: 1rem;
      max-width: 70%;
      padding: 0.8rem;
      border-radius: 1rem;
      background: #e0e0e0;
    }
    .own-message {
      margin-left: auto;
      background: #007bff;
      color: white;
    }
    #input-container {
      position: fixed;
      bottom: 0;
      width: 100%;
      max-width: var(--max-width);
      background: white;
      padding: 1rem;
      display: flex;
      gap: 0.5rem;
    }
    #message-input {
      flex: 1;
      padding: 0.8rem;
      border: 1px solid #ddd;
      border-radius: 1.5rem;
    }
    button.send {
      padding: 0.8rem 1.5rem;
      border: none;
      border-radius: 1.5rem;
      background: #007bff;
      color: white;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <!-- Authentication UI -->
  <div id="auth-container">
    <h2 id="auth-title">Login</h2>
    <form id="auth-form">
      <input type="email" id="email" placeholder="Email" required>
      <input type="password" id="password" placeholder="Password" required>
      <button type="submit" id="auth-button">Login</button>
    </form>
    <button id="toggle-auth">Switch to Signup</button>
    <div id="auth-error" style="color: red;"></div>
  </div>

  <!-- Chat UI (initially hidden) -->
  <div id="chat-container" style="display: none;">
    <div id="messages"></div>
    <div id="input-container">
      <input type="text" id="message-input" placeholder="Type message...">
      <button class="send" onclick="sendMessage()">Send</button>
    </div>
  </div>

  <!-- PocketBase Client Library -->
  <script src="https://unpkg.com/pocketbase@0.25.0/dist/pocketbase.umd.js"></script>
  <script>
    const pb = new PocketBase('http://127.0.0.1:8090');

    // Global state for current user (after auth)
    let currentUser = null;
    // Track auth mode: "login" or "signup"
    let authMode = "login";

    // DOM Elements
    const authContainer = document.getElementById('auth-container');
    const authForm = document.getElementById('auth-form');
    const authTitle = document.getElementById('auth-title');
    const authButton = document.getElementById('auth-button');
    const toggleAuthButton = document.getElementById('toggle-auth');
    const authError = document.getElementById('auth-error');
    const chatContainer = document.getElementById('chat-container');
    const messagesContainer = document.getElementById('messages');
    const messageInput = document.getElementById('message-input');

    // Toggle between login and signup
    toggleAuthButton.addEventListener('click', () => {
      authMode = authMode === "login" ? "signup" : "login";
      authTitle.textContent = authMode === "login" ? "Login" : "Signup";
      authButton.textContent = authMode === "login" ? "Login" : "Signup";
      toggleAuthButton.textContent = authMode === "login" ? "Switch to Signup" : "Switch to Login";
      authError.textContent = "";
    });

    // Handle authentication form submission
    authForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const email = document.getElementById('email').value.trim();
      const password = document.getElementById('password').value;
      try {
        if (authMode === "login") {
          // Login using email and password
          const authData = await pb.collection('users').authWithPassword(email, password);
          currentUser = authData.record;
        } else {
          // Signup: Create a new user then login
          const newUser = await pb.collection('users').create({
            email: email,
            password: password,
            passwordConfirm: password
          });
          // After signup, authenticate the new user
          const authData = await pb.collection('users').authWithPassword(email, password);
          currentUser = authData.record;
        }
        // Clear any error messages and show the chat UI
        authError.textContent = "";
        authContainer.style.display = "none";
        chatContainer.style.display = "flex";
        initializeChat();
      } catch (err) {
        console.error(err);
        authError.textContent = err.message || "Authentication failed.";
      }
    });

    // Initialize chat functionality after authentication
    function initializeChat() {
      // Optionally, you can use currentUser.email or currentUser.id
      console.log("Authenticated as", currentUser);

      // Subscribe to real-time events on the "messages" collection.
      pb.collection('messages').subscribe('*', function (e) {
        // Only add the message if it was not already added (optional check)
        addMessageToUI(e.record);
      });

      // Load existing messages
      pb.collection('messages').getList(1, 50, {
        sort: '-created'
      }).then(res => {
        // Reverse to show oldest messages first.
        res.items.reverse().forEach(addMessageToUI);
      });
    }

    // Send a message to PocketBase.
    function sendMessage() {
      const input = document.getElementById('message-input');
      const text = input.value.trim();
      if (!text) return;
      pb.collection('messages').create({
        user: currentUser.email, // or use currentUser.id or another identifier
        message: text
      }).catch(err => {
        console.error("Failed to send message:", err);
      });
      input.value = '';
    }

    // Add a message element to the UI.
    function addMessageToUI(message) {
      const div = document.createElement('div');
      div.className = `message ${message.user === currentUser.email ? 'own-message' : ''}`;
      div.innerHTML = `
        <strong>${message.user}</strong>
        <p>${message.message}</p>
        <small>${new Date(message.created).toLocaleTimeString()}</small>
      `;
      messagesContainer.appendChild(div);
      // Auto-scroll to the bottom
      window.scrollTo(0, document.body.scrollHeight);
    }
  </script>
</body>
</html>
