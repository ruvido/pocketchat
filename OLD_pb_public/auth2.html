<!DOCTYPE html>
<html lang="en">
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        :root { --max-width: 600px; }
        * { box-sizing: border-box; }
        body { 
            margin: 0; 
            font-family: system-ui;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }
        #messages {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
            padding-bottom: 70px;
        }
        .message {
            margin-bottom: 1rem;
            max-width: 70%;
            padding: 0.8rem;
            border-radius: 1rem;
            background: #e0e0e0;
        }
        .own-message {
            margin-left: auto;
            background: #007bff;
            color: white;
        }
        #input-container {
            position: fixed;
            bottom: 0;
            width: 100%;
            max-width: var(--max-width);
            background: white;
            padding: 1rem;
            display: flex;
            gap: 0.5rem;
        }
        #message-input {
            flex: 1;
            padding: 0.8rem;
            border: 1px solid #ddd;
            border-radius: 1.5rem;
        }
        button {
            padding: 0.8rem 1.5rem;
            border: none;
            border-radius: 1.5rem;
            background: #007bff;
            color: white;
        }
#auth-container {
    padding: 2rem;
    max-width: 400px;
    margin: 0 auto;
}

#auth-container input {
    display: block;
    width: 100%;
    padding: 0.8rem;
    margin: 0.5rem 0;
    border: 1px solid #ddd;
    border-radius: 0.5rem;
}

#auth-container button {
    margin: 0.5rem 0.2rem;
}
    </style>
</head>
<body>
    <div id="auth-container" style="display: none;">
        <h2>Chat Login</h2>
        <input type="email" id="auth-email" placeholder="Email">
        <input type="password" id="auth-password" placeholder="Password">
        <button onclick="handleLogin()">Login</button>
        <button onclick="handleRegister()">Register</button>
    </div>

    <div id="chat-container" style="display: none;">
        <div id="messages"></div>
        <div id="input-container">
            <input type="text" id="message-input">
            <button onclick="sendMessage()">Send</button>
        </div>
    </div>

    <script src="https://unpkg.com/pocketbase@0.25.0/dist/pocketbase.umd.js"></script>
    <script>
        const pb = new PocketBase('http://127.0.0.1:8090');
        
        // Auto-load auth from localStorage
        const storedAuth = localStorage.getItem('pb_auth');
        if (storedAuth) {
            pb.authStore.loadFromCookie(storedAuth);
        }
        // Check existing auth
        if(pb.authStore.isValid) {
            showChatUI();
            loadMessages();
        } else {
            showAuthUI();
        }

        async function handleLogin() {
            try {
                await pb.collection('users').authWithPassword(
                    document.getElementById('auth-email').value,
                    document.getElementById('auth-password').value
                );
                localStorage.setItem('pb_auth', pb.authStore.exportToCookie());
                showChatUI();
                loadMessages();
            } catch (err) {
                alert('Login failed: ' + err.message);
            }
        }

        async function handleRegister() {
            try {
                const username = prompt('Choose a username')?.trim();
                if (!username) {
                    alert('Username is required!');
                    return;
                }

                const data = {
                    username: username,
                    email: document.getElementById('auth-email').value,
                    password: document.getElementById('auth-password').value,
                    passwordConfirm: document.getElementById('auth-password').value
                };

                await pb.collection('users').create(data);
                await handleLogin();
            } catch (err) {
                alert('Registration failed: ' + err.message);
            }
        }

        function showChatUI() {
            document.getElementById('auth-container').style.display = 'none';
            document.getElementById('chat-container').style.display = 'block';
            setupRealtime();
        }

        function showAuthUI() {
            document.getElementById('auth-container').style.display = 'block';
            document.getElementById('chat-container').style.display = 'none';
        }

        // Modified message functions

        async function loadMessages() {
            const result = await pb.collection('messages').getList(1, 50, {
                sort: '-created',
                expand: 'user'  // Ensure expansion is requested
            });

            result.items.reverse().forEach(msg => {
                // Add fallback for missing expansion
                msg.expand = msg.expand || {};
                msg.expand.user = msg.expand.user || { username: 'Unknown' };
                addMessageToUI(msg);
            });
        }

        // Update the sendMessage function:
        async function sendMessage() {
            if (!pb.authStore.isValid) {
                alert('You need to login first!');
                return;
            }

            const input = document.getElementById('message-input');
            try {
                await pb.collection('messages').create({
                    user: pb.authStore.model.id,
                    message: input.value
                });
                input.value = '';
            } catch (err) {
                alert('Failed to send message: ' + err.message);
            }
        }

        // Update the realtime subscription:
        function setupRealtime() {
            pb.collection('messages').subscribe('*', async e => {
                try {
                    // Always refetch with expansion
                    const msg = await pb.collection('messages').getOne(e.record.id, {
                        expand: 'user'
                    });
                    msg.expand = msg.expand || {};
                    msg.expand.user = msg.expand.user || { username: 'Unknown' };
                    addMessageToUI(msg);
                } catch (err) {
                    console.error('Error fetching expanded message:', err);
                }
            });
        }

        function addMessageToUI(msg) {
            const div = document.createElement('div');
            const user = msg.expand?.user || { username: 'Unknown', id: '' };

            div.className = `message ${user.id === pb.authStore.model?.id ? 'own-message' : ''}`;
            div.innerHTML = `
        <strong>${user.username}</strong>
        <p>${msg.message}</p>
        <small>${new Date(msg.created).toLocaleTimeString()}</small>
    `;

            const messagesContainer = document.getElementById('messages');
            messagesContainer.appendChild(div);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }


    </script>
</body>
</html>
